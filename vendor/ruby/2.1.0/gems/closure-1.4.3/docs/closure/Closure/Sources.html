<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Closure::Sources
  
    &mdash; Documentation by YARD 0.7.3
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (S)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Closure.html" title="Closure (class)">Closure</a></span></span>
     &raquo; 
    <span class="title">Sources</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Closure::Sources
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Closure::Sources</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">Enumerable</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/closure/sources.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
This class is responsible for scanning source files and managing
dependencies.
</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="GOOG_REGEX_STRING-constant" class="">GOOG_REGEX_STRING =
          <div class="docstring">
  <div class="discussion">
    <p>
Using regular expressions may seem clunky, but the Python scripts did it
this way and I&#8217;ve not see it fail in practice.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>^\s*goog\.%s\s*\(\s*[\'&quot;]([^\)]+)[\'&quot;]\s*\)</span><span class='tstring_end'>'</span></span></pre></dd>
      
        <dt id="PROVIDE_REGEX-constant" class="">PROVIDE_REGEX =
          
        </dt>
        <dd><pre class="code"><span class='const'>Regexp</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='const'>GOOG_REGEX_STRING</span> <span class='op'>%</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>provide</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span></pre></dd>
      
        <dt id="REQUIRE_REGEX-constant" class="">REQUIRE_REGEX =
          
        </dt>
        <dd><pre class="code"><span class='const'>Regexp</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='const'>GOOG_REGEX_STRING</span> <span class='op'>%</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>require</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span></pre></dd>
      
        <dt id="BASE_JS_REGEX-constant" class="">BASE_JS_REGEX =
          <div class="docstring">
  <div class="discussion">
    <p>
Google Closure Library base.js is the file with no provides, no requires,
and defines goog a particular way.
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^var goog = goog \|\| \{\};</span><span class='regexp_end'>/</span></span></pre></dd>
      
        <dt id="ENV_FLAG-constant" class="">ENV_FLAG =
          <div class="docstring">
  <div class="discussion">
    <p>
Flag env so that refresh is never run more than once per request
</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>closure.sources_fresh</span><span class='tstring_end'>'</span></span></pre></dd>
      
    </dl>
  


  
  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#dwell-instance_method" title="#dwell (instance method)">- (Float) <strong>dwell</strong> </a>
    

    
  </span>
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Limits how often a full refresh is allowed to run.
</p>
</div></span>
  
</li>

    
  </ul>



  

  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add-instance_method" title="#add (instance method)">- (Sources) <strong>add</strong>(directory, path = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Adds a new directory of source files.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#base_js-instance_method" title="#base_js (instance method)">- (String) <strong>base_js</strong>(env = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Determine the path_info and query_string for loading base_js.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#deps_js-instance_method" title="#deps_js (instance method)">- (String) <strong>deps_js</strong>(env = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Determine the path_info for where deps_js is located.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#deps_response-instance_method" title="#deps_response (instance method)">- (Rack::Response) <strong>deps_response</strong>(base, env = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Builds a Rack::Response to serve a dynamic deps.js.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#each-instance_method" title="#each (instance method)">- <strong>each</strong> {|path, directory| ... }</a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Yields path and directory for each of the added sources.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#files_for-instance_method" title="#files_for (instance method)">- (Array&lt;String&gt;) <strong>files_for</strong>(namespace, filenames = nil, env = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Calculate all required files for a namespace.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Sources) <strong>initialize</strong>(dwell = 1.0) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
A new instance of Sources.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#invalidate-instance_method" title="#invalidate (instance method)">- <strong>invalidate</strong>(env) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Certain Script operations, such as building Templates, will need to
invalidate the cache.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#namespaces_for-instance_method" title="#namespaces_for (instance method)">- (String) <strong>namespaces_for</strong>(filename, env = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Return all provided and required namespaces for a file.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#src_for-instance_method" title="#src_for (instance method)">- (String) <strong>src_for</strong>(filename, env = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Calculate the file server path for a filename.
</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Closure::Sources (class)">Sources</a></span></tt>) <strong>initialize</strong>(dwell = 1.0) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
A new instance of Sources
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>dwell</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>1.0</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>
in seconds.
</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


48
49
50
51
52
53
54
55</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 48</span>

<span class='kw'>def</span> <span class='id initialize'>initialize</span><span class='lparen'>(</span><span class='id dwell'>dwell</span> <span class='op'>=</span> <span class='float'>1.0</span><span class='rparen'>)</span>
  <span class='ivar'>@dwell</span> <span class='op'>=</span> <span class='id dwell'>dwell</span>
  <span class='ivar'>@files</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='ivar'>@sources</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@semaphore</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id new'>new</span>
  <span class='ivar'>@last_been_run</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id reset_all_computed_instance_vars'>reset_all_computed_instance_vars</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="dwell=-instance_method"></span>
      <span id="dwell-instance_method"></span>
      <div class="method_details first">
  <p class="signature first" id="dwell-instance_method">
  
    - (<tt>Float</tt>) <strong>dwell</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Limits how often a full refresh is allowed to run.  Blocked threads can
trigger unneeded refreshes in rare scenarios. Also sent to browser in
cache-control for frames performance. Caching, lazy loading, and flagging
(of env) make up the remaining techniques for good performance.
</p>


  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


64
65
66</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 64</span>

<span class='kw'>def</span> <span class='id dwell'>dwell</span>
  <span class='ivar'>@dwell</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="add-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="Closure::Sources (class)">Sources</a></span></tt>) <strong>add</strong>(directory, path = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Adds a new directory of source files.
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>path</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>
Where to mount on the http server.
</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>directory</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>
Filesystem location of your sources.
</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="Closure::Sources (class)">Sources</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>
self
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


71
72
73
74
75
76
77
78
79
80
81
82
83</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 71</span>

<span class='kw'>def</span> <span class='id add'>add</span><span class='lparen'>(</span><span class='id directory'>directory</span><span class='comma'>,</span> <span class='id path'>path</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>immutable once used</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@last_been_run</span>
  <span class='kw'>if</span> <span class='id path'>path</span>
    <span class='id raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>path must start with /</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id path'>path</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>%r{</span><span class='tstring_content'>^/</span><span class='regexp_end'>}</span></span>
    <span class='id path'>path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span> <span class='kw'>if</span> <span class='id path'>path</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span>
    <span class='id raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>path must not end with /</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id path'>path</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>%r{</span><span class='tstring_content'>/$</span><span class='regexp_end'>}</span></span>
    <span class='id raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>path already exists</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@sources</span><span class='period'>.</span><span class='id find'>find</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id s'>s</span><span class='op'>|</span><span class='id s'>s</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='op'>==</span><span class='id path'>path</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>
  <span class='id raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>directory already exists</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@sources</span><span class='period'>.</span><span class='id find'>find</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id s'>s</span><span class='op'>|</span><span class='id s'>s</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='op'>==</span><span class='id directory'>directory</span><span class='rbrace'>}</span>
  <span class='ivar'>@sources</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='const'>File</span><span class='period'>.</span><span class='id expand_path'>expand_path</span><span class='lparen'>(</span><span class='id directory'>directory</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id path'>path</span><span class='rbracket'>]</span>
  <span class='ivar'>@sources</span><span class='period'>.</span><span class='id sort!'>sort!</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id a'>a</span><span class='comma'>,</span><span class='id b'>b</span><span class='op'>|</span> <span class='lparen'>(</span><span class='id b'>b</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='op'>||</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='op'>&lt;=&gt;</span> <span class='lparen'>(</span><span class='id a'>a</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='op'>||</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="base_js-instance_method">
  
    - (<tt>String</tt>) <strong>base_js</strong>(env = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Determine the path_info and query_string for loading base_js.
</p>


  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


95
96
97
98
99
100
101
102
103
104</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 95</span>

<span class='kw'>def</span> <span class='id base_js'>base_js</span><span class='lparen'>(</span><span class='id env'>env</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id goog'>goog</span> <span class='op'>=</span> <span class='ivar'>@goog</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='ivar'>@last_been_run</span>
    <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id goog'>goog</span><span class='lbracket'>[</span><span class='symbol'>:base_js</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>?</span><span class='embexpr_beg'>#{</span><span class='id goog'>goog</span><span class='lbracket'>[</span><span class='symbol'>:base_js_mtime</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id to_i'>to_i</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id refresh'>refresh</span><span class='lparen'>(</span><span class='id env'>env</span><span class='rparen'>)</span>
    <span class='id raise'>raise</span> <span class='const'>BaseJsNotFoundError</span> <span class='kw'>unless</span> <span class='ivar'>@goog</span>
    <span class='ivar'>@goog</span><span class='lbracket'>[</span><span class='symbol'>:base_js</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="deps_js-instance_method">
  
    - (<tt>String</tt>) <strong>deps_js</strong>(env = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Determine the path_info for where deps_js is located.
</p>


  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


109
110
111
112
113
114
115
116
117
118
119
120
121</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 109</span>

<span class='kw'>def</span> <span class='id deps_js'>deps_js</span><span class='lparen'>(</span><span class='id env'>env</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='comment'># Because Server uses this on every call, it's best to never lock.
</span>  <span class='comment'># We grab a local goog so we don't need the lock if everything looks good.
</span>  <span class='comment'># This works because #refresh creates new @goog hashes instead of modifying.
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id goog'>goog</span> <span class='op'>=</span> <span class='ivar'>@goog</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='ivar'>@last_been_run</span>
    <span class='kw'>return</span> <span class='id goog'>goog</span><span class='lbracket'>[</span><span class='symbol'>:deps_js</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
  <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id refresh'>refresh</span><span class='lparen'>(</span><span class='id env'>env</span><span class='rparen'>)</span>
    <span class='id raise'>raise</span> <span class='const'>BaseJsNotFoundError</span> <span class='kw'>unless</span> <span class='ivar'>@goog</span>
    <span class='ivar'>@goog</span><span class='lbracket'>[</span><span class='symbol'>:deps_js</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="deps_response-instance_method">
  
    - (<tt>Rack::Response</tt>) <strong>deps_response</strong>(base, env = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Builds a Rack::Response to serve a dynamic deps.js
</p>


  </div>
</div>
<div class="tags">
  
<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Rack::Response</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 126</span>

<span class='kw'>def</span> <span class='id deps_response'>deps_response</span><span class='lparen'>(</span><span class='id base'>base</span><span class='comma'>,</span> <span class='id env'>env</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id refresh'>refresh</span><span class='lparen'>(</span><span class='id env'>env</span><span class='rparen'>)</span>
    <span class='id base'>base</span> <span class='op'>=</span> <span class='const'>Pathname</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id base'>base</span><span class='rparen'>)</span>
    <span class='kw'>unless</span> <span class='ivar'>@deps</span><span class='lbracket'>[</span><span class='id base'>base</span><span class='rbracket'>]</span>
      <span class='id response'>response</span> <span class='op'>=</span> <span class='ivar'>@deps</span><span class='lbracket'>[</span><span class='id base'>base</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Response</span><span class='period'>.</span><span class='id new'>new</span>
      <span class='id response'>response</span><span class='period'>.</span><span class='id write'>write</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>// Dynamic Deps by Closure Script\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@files</span><span class='period'>.</span><span class='id sort'>sort</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id a'>a</span><span class='comma'>,</span><span class='id b'>b</span><span class='op'>|</span><span class='lparen'>(</span><span class='id a'>a</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span><span class='op'>||</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='op'>&lt;=&gt;</span><span class='lparen'>(</span><span class='id b'>b</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span><span class='op'>||</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id filename'>filename</span><span class='comma'>,</span> <span class='id dep'>dep</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id dep'>dep</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span>
          <span class='id path'>path</span> <span class='op'>=</span> <span class='const'>Pathname</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id dep'>dep</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id relative_path_from'>relative_path_from</span><span class='lparen'>(</span><span class='id base'>base</span><span class='rparen'>)</span>
          <span class='id path'>path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id path'>path</span><span class='rbrace'>}</span><span class='tstring_content'>?</span><span class='embexpr_beg'>#{</span><span class='id dep'>dep</span><span class='lbracket'>[</span><span class='symbol'>:mtime</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id to_i'>to_i</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
          <span class='id response'>response</span><span class='period'>.</span><span class='id write'>write</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>goog.addDependency(</span><span class='embexpr_beg'>#{</span><span class='id path'>path</span><span class='period'>.</span><span class='id dump'>dump</span><span class='rbrace'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id dep'>dep</span><span class='lbracket'>[</span><span class='symbol'>:provide</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id inspect'>inspect</span><span class='rbrace'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id dep'>dep</span><span class='lbracket'>[</span><span class='symbol'>:require</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id inspect'>inspect</span><span class='rbrace'>}</span><span class='tstring_content'>);\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='id response'>response</span><span class='period'>.</span><span class='id headers'>headers</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>application/javascript</span><span class='tstring_end'>'</span></span>
      <span class='id response'>response</span><span class='period'>.</span><span class='id headers'>headers</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Cache-Control</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>max-age=</span><span class='embexpr_beg'>#{</span><span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span><span class='ivar'>@dwell</span><span class='period'>.</span><span class='id floor'>floor</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id max'>max</span><span class='rbrace'>}</span><span class='tstring_content'>, private, must-revalidate</span><span class='tstring_end'>&quot;</span></span>
      <span class='id response'>response</span><span class='period'>.</span><span class='id headers'>headers</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Last-Modified</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span><span class='period'>.</span><span class='id httpdate'>httpdate</span>
    <span class='kw'>end</span>
    <span class='id mod_since'>mod_since</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id httpdate'>httpdate</span><span class='lparen'>(</span><span class='id env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>HTTP_IF_MODIFIED_SINCE</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id mod_since'>mod_since</span> <span class='op'>==</span> <span class='const'>Time</span><span class='period'>.</span><span class='id httpdate'>httpdate</span><span class='lparen'>(</span><span class='ivar'>@deps</span><span class='lbracket'>[</span><span class='id base'>base</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id headers'>headers</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Last-Modified</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Response</span><span class='period'>.</span><span class='id new'>new</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='int'>304</span> <span class='comment'># Not Modified
</span>    <span class='kw'>else</span>
      <span class='ivar'>@deps</span><span class='lbracket'>[</span><span class='id base'>base</span><span class='rbracket'>]</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="each-instance_method">
  
    - <strong>each</strong> {|path, directory| ... }
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Yields path and directory for each of the added sources.
</p>


  </div>
</div>
<div class="tags">
  
<h3>Yields:</h3>
<ul class="yield">
  
    <li>
      
      
        <span class='type'>(<tt>path</tt>, <tt>directory</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


88
89
90</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 88</span>

<span class='kw'>def</span> <span class='id each'>each</span>
  <span class='ivar'>@sources</span><span class='period'>.</span><span class='id each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id directory'>directory</span><span class='comma'>,</span> <span class='id path'>path</span><span class='op'>|</span> <span class='kw'>yield</span> <span class='id directory'>directory</span><span class='comma'>,</span> <span class='id path'>path</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="files_for-instance_method">
  
    - (<tt>Array&lt;String&gt;</tt>) <strong>files_for</strong>(namespace, filenames = nil, env = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Calculate all required files for a namespace.
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>namespace</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>
New Array of filenames.
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 157</span>

<span class='kw'>def</span> <span class='id files_for'>files_for</span><span class='lparen'>(</span><span class='id namespace'>namespace</span><span class='comma'>,</span> <span class='id filenames'>filenames</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id env'>env</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id ns'>ns</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id refresh'>refresh</span><span class='lparen'>(</span><span class='id env'>env</span><span class='rparen'>)</span>
    <span class='comment'># Pivot the deps to a namespace hash
</span>    <span class='comment'># @ns is cleared when any requires or provides changes
</span>    <span class='kw'>unless</span> <span class='ivar'>@ns</span>
      <span class='ivar'>@ns</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='ivar'>@files</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id filename'>filename</span><span class='comma'>,</span> <span class='id dep'>dep</span><span class='op'>|</span>
        <span class='id dep'>dep</span><span class='lbracket'>[</span><span class='symbol'>:provide</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id provide'>provide</span><span class='op'>|</span>
          <span class='kw'>if</span> <span class='ivar'>@ns</span><span class='lbracket'>[</span><span class='id provide'>provide</span><span class='rbracket'>]</span>
            <span class='ivar'>@ns</span> <span class='op'>=</span> <span class='kw'>nil</span>
            <span class='id raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Namespace </span><span class='embexpr_beg'>#{</span><span class='id provide'>provide</span><span class='period'>.</span><span class='id dump'>dump</span><span class='rbrace'>}</span><span class='tstring_content'> provided more than once.</span><span class='tstring_end'>&quot;</span></span>
          <span class='kw'>end</span>
          <span class='ivar'>@ns</span><span class='lbracket'>[</span><span class='id provide'>provide</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span>
            <span class='symbol'>:filename</span> <span class='op'>=&gt;</span> <span class='id filename'>filename</span><span class='comma'>,</span>
            <span class='symbol'>:require</span> <span class='op'>=&gt;</span> <span class='id dep'>dep</span><span class='lbracket'>[</span><span class='symbol'>:require</span><span class='rbracket'>]</span>
          <span class='rbrace'>}</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id ns'>ns</span> <span class='op'>=</span> <span class='ivar'>@ns</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id filenames'>filenames</span> <span class='kw'>or</span> <span class='id filenames'>filenames</span><span class='period'>.</span><span class='id empty?'>empty?</span>
      <span class='id raise'>raise</span> <span class='const'>BaseJsNotFoundError</span> <span class='kw'>unless</span> <span class='ivar'>@goog</span>
      <span class='id filenames'>filenames</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id filenames'>filenames</span> <span class='op'>&lt;&lt;</span> <span class='ivar'>@goog</span><span class='lbracket'>[</span><span class='symbol'>:base_filename</span><span class='rbracket'>]</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># Since @ns is only unset, not modified, by another thread, we
</span>  <span class='comment'># can work with a local reference.  This has been finely tuned and
</span>  <span class='comment'># runs fast, but it's still nice to release any other threads early.
</span>  <span class='id calcdeps'>calcdeps</span><span class='lparen'>(</span><span class='id ns'>ns</span><span class='comma'>,</span> <span class='id namespace'>namespace</span><span class='comma'>,</span> <span class='id filenames'>filenames</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="invalidate-instance_method">
  
    - <strong>invalidate</strong>(env) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Certain Script operations, such as building Templates, will need to
invalidate the cache.
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


222
223
224
225</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 222</span>

<span class='kw'>def</span> <span class='id invalidate'>invalidate</span><span class='lparen'>(</span><span class='id env'>env</span><span class='rparen'>)</span>
  <span class='id env'>env</span><span class='period'>.</span><span class='id delete'>delete</span> <span class='const'>ENV_FLAG</span>
  <span class='ivar'>@last_been_run</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id at'>at</span> <span class='int'>0</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="namespaces_for-instance_method">
  
    - (<tt>String</tt>) <strong>namespaces_for</strong>(filename, env = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Return all provided and required namespaces for a file.
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>filename</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


210
211
212
213
214
215
216
217</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 210</span>

<span class='kw'>def</span> <span class='id namespaces_for'>namespaces_for</span><span class='lparen'>(</span><span class='id filename'>filename</span><span class='comma'>,</span> <span class='id env'>env</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id refresh'>refresh</span><span class='lparen'>(</span><span class='id env'>env</span><span class='rparen'>)</span>
    <span class='id file'>file</span> <span class='op'>=</span> <span class='ivar'>@files</span><span class='lbracket'>[</span><span class='id filename'>filename</span><span class='rbracket'>]</span>
    <span class='id raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id filename'>filename</span><span class='period'>.</span><span class='id dump'>dump</span><span class='rbrace'>}</span><span class='tstring_content'> not found</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id file'>file</span>
    <span class='id file'>file</span><span class='lbracket'>[</span><span class='symbol'>:provide</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='id file'>file</span><span class='lbracket'>[</span><span class='symbol'>:require</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="src_for-instance_method">
  
    - (<tt>String</tt>) <strong>src_for</strong>(filename, env = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Calculate the file server path for a filename
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>filename</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


195
196
197
198
199
200
201
202
203
204</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/closure/sources.rb', line 195</span>

<span class='kw'>def</span> <span class='id src_for'>src_for</span><span class='lparen'>(</span><span class='id filename'>filename</span><span class='comma'>,</span> <span class='id env'>env</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='ivar'>@semaphore</span><span class='period'>.</span><span class='id synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id refresh'>refresh</span><span class='lparen'>(</span><span class='id env'>env</span><span class='rparen'>)</span>
    <span class='id file'>file</span> <span class='op'>=</span> <span class='ivar'>@files</span><span class='lbracket'>[</span><span class='id filename'>filename</span><span class='rbracket'>]</span>
    <span class='kw'>unless</span> <span class='id file'>file</span> <span class='kw'>and</span> <span class='id file'>file</span><span class='period'>.</span><span class='id has_key?'>has_key?</span> <span class='symbol'>:path</span>
      <span class='id raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id filename'>filename</span><span class='period'>.</span><span class='id dump'>dump</span><span class='rbrace'>}</span><span class='tstring_content'> is not available from file server</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id file'>file</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>?</span><span class='embexpr_beg'>#{</span><span class='id file'>file</span><span class='lbracket'>[</span><span class='symbol'>:mtime</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id to_i'>to_i</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Sun Oct 23 22:43:17 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.3 (ruby-1.9.2).
</div>

  </body>
</html>